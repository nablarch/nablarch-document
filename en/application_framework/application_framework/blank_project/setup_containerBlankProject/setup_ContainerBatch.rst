----------------------------------------------------------
Initial Setup of Nablarch batch Project for Container
----------------------------------------------------------

The following is procedures of initial setup of the Nablarch batch project for container:

* Generating Nablarch batch project for container
* Confirm communications of Nablarch batch project
* Create a container image
* Run Container Image


Overview of the generated project
----------------------------------------------------------

The overview of the project generated by this procedure is as follows.

.. list-table::
  :header-rows: 1
  :class: white-space-normal
  :widths: 8,20

  * - Item
    - Description
  * - Project type
    - Maven project
  * - Project composition
    - Single project composition
  * - DB used
    - H2 Database Engine (embedded in the application)
  * - What is included in the generated project?
    - The following is included in the generated project:

      * Basic configuration for the Nablarch batch application
      * On-demand batch application for communication confirmation
      * Messaging using tables as queues for communication confirmation
      * Email send batch configuration \ [#mailSendBatch]_\
      * Initial configuration of the tool that operates in conjunction with Maven (is imported by referring to :ref:`about_maven_parent_module`).


.. [#mailSendBatch]
   Email send batch functions as a :ref:`resident batch<nablarch_batch-resident_batch>` and sends mail to the SMTP server.
   Sample component configuration file is present in ``src/main/resources/mail-sender-boot.xml``.
   Email send batch is not necessary when building the initial environment, but when it becomes necessary, use after reading the description of :ref:`send email<mail>`.


For relationship with other projects and directories, see :doc:`../MavenModuleStructures/index`.

.. _firstStepGenerateContainerBatchBlankProject:

Create blank project
----------------------------------------------------------

Generate a blank project using the archetypes provided by Nablarch.


Execute the mvn command
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Use `Maven Archetype Plugin(external site) <https://maven.apache.org/archetype/maven-archetype-plugin/usage.html>`_ to generate a blank project.

Change the current directory to the directory where the blank project (can be any directory) is to be created.

Execute the following command.

.. code-block:: bat

  mvn archetype:generate -DarchetypeGroupId=com.nablarch.archetype -DarchetypeArtifactId=nablarch-container-batch-archetype -DarchetypeVersion={nablarch_version}

The version of Nablarch used in the above command is |nablarch_version|. If you want to change the version, change the following parameters.

.. list-table::
  :header-rows: 1
  :class: white-space-normal
  :widths: 6,20

  * - Set value
    - Description
  * - archetypeVersion
    - Specify the version of the archetype you wish to use. (Nablarch 5u25 or later must be specified)

.. tip::
  If you want to generate blank projects with Nablarch 5u24 or earlier, change ``archetype:generate`` to ``org.apache.maven.plugins:maven-archetype-plugin:2.4:generate`` in the above command and execute as in the following example.

  .. code-block:: bat

    mvn org.apache.maven.plugins:maven-archetype-plugin:2.4:generate -DarchetypeGroupId=com.nablarch.archetype -DarchetypeArtifactId=nablarch-container-batch-archetype -DarchetypeVersion=5u24

  The version of Nablarch used in this example is 5u24. If you want to change the version, change the parameter archetypeVersion in the same way.

Enter project information
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

When the above command is executed, you will be asked to enter the following information about the blank project to be generated.

=========== ================================================= =======================
Input item  Description                                       Configuration example
=========== ================================================= =======================
groupId      Group ID (normally, enter the package name)      ``com.example``
artifactId   Artifact ID                                      ``myapp-container-batch``
version      Version number                                   ``0.1.0``
package      Package (normally the same as group ID)          ``com.example``
=========== ================================================= =======================

.. important::
   Item groupId and package are mapped to the Java package name.
   Use lowercase letters, numbers, and dots for these input values, and do not use hyphens.

When you have finished entering project information, Y: : will appear.

 * Enter 「Y」 if you want to generate a template based on the information you have entered.
 * Enter 「N」 if you wish to redo the project information entry.

If the command ends normally, a blank project is created under the current directory.

.. _firstStepContainerBatchStartupTest:

Communication confirmation
-------------------------------------------

The communication confirmation mechanism and procedures are the same as for a normal Nablarch batch project. Thus, see :ref:`Initial Setup of the Nablarch Batch Project <firstStepBatchStartupTest>`.

.. note::

  The artifact ID should be replaced with ``myapp-container-batch`` to specify the directory and command.


.. _firstStepBuildContainerBatchDockerImage:

Create a container image
----------------------------------

The blank project has a plugin named `Jib <https://github.com/GoogleContainerTools/jib/tree/master/jib-maven-plugin>`_ (External sites) built in to create an image of a Docker container.

The ``jib: dockerBuild`` goal of this plugin can be executed to create a container image.

.. code-block:: text


  cd myapp-container-batch
  mvn compile jib:dockerBuild


If the execution is successful, the log given below will be output to the console.

.. code-block:: text

  (omission)
  [INFO] Built image to Docker daemon as myapp-container-batch, myapp-container-batch, myapp-container-batch:0.1.0
  [INFO] Executing tasks:
  [INFO] [==============================] 100.0% complete
  [INFO]
  [INFO] ------------------------------------------------------------------------
  [INFO] BUILD SUCCESS
  [INFO] ------------------------------------------------------------------------
  (Omitted)

Built Docker images are stored in a local repository.
Can see the images stored in the local repository with the following command.

.. code-block:: text

  docker image ls
  REPOSITORY              TAG         IMAGE ID       CREATED        SIZE
  myapp-container-batch   0.1.0       1cafd4108237   51 years ago   253MB
  myapp-container-batch   latest      1cafd4108237   51 years ago   253MB

Can see that there are 2 images registered: ``myapp-container-batch:0.1.0`` and ``myapp-container-batch:latest`` .

As you can see, the blank project is configured to create the following two images by executing ``jib:dockerBuild``.

* ``${project.artifactId}:latest``
* ``${project.artifactId}:${project.version}``

`OpenJDK image <https://hub.docker.com/_/adoptopenjdk>`_ (External sites) is used as base image by default.

The base image can be changed with the ``jib.from.image`` property.
For example, if you want to use ``adoptopenjdk:11.0.11_9-jre-hotspot`` for your base image, you would write it in ``pom.xml`` .

.. code-block:: xml

  <project>
    <! -- Omitted ...-->
    <properties>
      <! -- Omitted ...-->
      <jib.from.image>adoptopenjdk:11.0.11_9-jre-hotspot</jib.from.image>
    </properties>
    <! -- Omitted ...-->
  </project>

.. tip::

  In the blank project, the base image is specified with a Docker image tag. In this case, the latest version of the specified image will be selected.
  If a different version is selected than at the time of verification, it may affect the operation of the application.
  Therefore, it is recommended to specify the base image as a digest in order to specify exactly which version, after the test is completed.

  An example of setting by digest is shown below.

  .. code-block:: xml

    <jib.from.image>adoptopenjdk@sha256:df316691a2c655de2f835a626f8611c74af67dad2cf92711f6608b54e5aa6c61</jib.from.image>

.. _firstStepRunContainerBatchDockerImage:

Run a container image
----------------------------------

Once you have created a container image, you can run it with the following command.

.. _firstStepContainerBatchStartupInnerBatchOndemand:

On-demand batch
~~~~~~~~~~~~~~~~~
.. code-block:: text

  cd myapp-container-batch
  docker run  --rm -v %CD%\\h2:/h2 -v %CD%\\src\\main\\format:/var/nablarch/format -v %CD%\\work\\output:/var/nablarch/output  --name myapp-container-batch myapp-container-batch:latest -diConfig classpath:batch-boot.xml -requestPath SampleBatch -userId batch_user

It works the same as for :ref:`Communication confirmation (on-demand batch))<firstStepBatchStartupTest>`.
If the startup is successful, a log similar to :ref:`Launching the on-demand batch application <firstStepBatchExecOnDemandBatch>` will be output to the console.

.. _firstStepContainerBatchStartupInnerBatchDbMessaging:

Messaging Using Tables as Queues
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
.. code-block:: text

  cd myapp-container-batch
  docker run -it  --rm -v %CD%\\h2:/h2 --name myapp-container-batch --rm myapp-container-batch:latest -diConfig classpath:resident-batch-boot.xml -requestPath SampleResiBatch -userId batch_user

It works the same as for :ref:`Communication confirmation (messaging using tables as queues)<firstStepBatchStartupTestDbMessagingBatch>` .
If the startup is successful, a log similar to :ref:`Launching the application <firstStepBatchExecDbMessagingBatch>` will be output to the console.
It will go into standby mode, so force quit it with ctrl+c after confirming.

Supplementary notes
--------------------
 
 About the commands to run the container image.
  * When the above command is executed, the container will be started, batch processing will be executed, and then the container will be terminated automatically.
    Also, -rm option is specified in order to make automatically container deleted when the container is ended.

  * The above command is an example of the case where SAMPLE.h2.db, which is included in the blank project beforehand, is used as the database.
    If you do not use SAMPLE.h2.db, you do not need to specify a volume (``-v``) for ``%CD%\\h2:/h2``.

  * In addition to the above, in :ref:`On-demand batch<firstStepContainerBatchStartupInnerBatchOndemand>` The blank project ``./work/format`` and ``./work/output`` are mounted in a container.

  * Even for :ref:`Messaging Using Tables as Queues<firstStepContainerBatchStartupInnerBatchDbMessaging>`, the ``-it option`` of the docker command can be omitted, but the batch cannot be killed by ctrl+c from the docker host.
    In that case, exit the container with the following command.


     .. code-block:: text

      docker stop myapp-container-batch

 About Docker 
  Running Docker assumes that you are using Docker Desktop (see :ref:`Prerequisite <firstStepPreamble>`).
  If you are using the Docker Toolbox, the volume specification in the above example will fail.

  If you are using the Docker Toolbox, Docker is running in a VM on VirtualBox.
  Therefore, the path that can be specified on the host side of the volume is the path on the VM.

  On Windows, by default ``C:\Users`` is mounted in ``/c/users`` on the VM.
  Thus, if you are using the Docker Toolbox, you must specify the volume as ``-v/c/users/path/to/project/h2:/usr/local/tomcat/h2`` .

 About H2 and tools
  For information on the method of confirming the data of H2 and tools included in the blank project, see :doc:`../firstStep_appendix/firststep_complement`.

